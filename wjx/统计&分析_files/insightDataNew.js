var requestimes=0,quesArr=[],isInsighting=!1,quesRes="",isStopInsight=!1,curDongchaArea=null,spssquestions=[],updateObj={},createAI=!1,finishiall=4,isAIshowstyle=!1,hasaipowwer=!0;function initInsightData(){var i=null;if(1==window.insightSign)i=$("table[qi]");else if(2==window.insightSign)i=$(".title-item[qtitle]");else if(3==window.insightSign)i=$(".cross-container");else{if(4==window.insightSign)return void renderSatisfaction($(this));5==window.insightSign?i=$(".cross-container"):6==window.insightSign&&(i=$(".dataItem"))}i.each(function(i){var t="",e=null;switch(window.insightSign){case 1:t=$(this).attr("qi"),e=$(this).closest(".title-item").find(".fillet__chart--dataGraph");break;case 2:t=$(this).attr("yqindex"),e=$(this).find(".fillet__chart--dataGraph");break;case 3:t=$(this).attr("tid"),e=$(this).find(".table_scroll");break;case 5:t=-1*(i+1),e=$(this).find(".table_scroll");break;case 6:t=i+1,e=$(this).find("table")}var n=t+"‡"+window.qCond+"‡"+window.eCond,n=hashTagObj[n],a=(n&&2==(a=n.split("‡")).length&&(LoagInsight(a[0],e),createAI=!0),getScoreCond()+"‡"+window.qCond+"‡"+window.eCond);if(hashTagObj[a]){a=hashTagObj[a].split("‡");2==a.length&&LoagInsight(a[0],$(".markScatter"))}else if(!n&&createAI)for(var s=0;s<quesArr.length;s++)if(quesArr[s].qi==t){LoagInsight("none",e);break}})}-1<location.href.indexOf("isai=1")&&(isAIshowstyle=!0,$(".two-stage-title input[type=button]").hide(),$(".lazyload").hide()),hashTagObj.AgreeDeclare&&(insightDeclare=1),$(function(){!window.isShare&&-1!=window.quesId||hashTagObj[10*activityId+1+"‡"+window.qCond+"‡"+window.eCond]||hashTagObj[10*activityId+"‡"+window.qCond+"‡"+window.eCond]||($(".insightBtn").hide(),hasaipowwer=!1),isAIshowstyle&&$(".insightBtn").hide(),2==window.insightSign&&-1==location.href.toLowerCase().indexOf("reportid")&&$(".insightBtn").hide(),isAIshowstyle&&(window.isMobile?hashTagObj[10*activityId+1+"‡"+window.qCond+"‡"+window.eCond]||createAI||hashTagObj[10*activityId+"‡"+window.qCond+"‡"+window.eCond]?(toInsightDiv(1),initInsightData(),checkHasInsightAllResult(),initAiUi()):hasaipowwer&&($(".insightPart1, .insightPart2").hide(),$(".outer_ai,#divMore").hide(),$(".insightPart3 .insightBtns>div").eq(0).hide(),$("#moInsightAgreement,.insightPart3").show(),$("#moInsightAgreement").css("opacity","1")):hasaipowwer&&(window.isShare&&$("#divSumData").css("padding","0 15px"),toInsightDiv(1),initInsightData(),checkHasInsightAllResult(),changeAiReport()));var i=getScoreCond()+"‡"+window.qCond+"‡"+window.eCond;hashTagObj[i]&&2==(i=hashTagObj[i].split("‡")).length&&LoagInsight(i[0],$(".markScatter")),$(".download_dongcha").mouseleave(function(){event.stopPropagation(),$(".download_dongcha").hide()})});var insightAllLoadingInterval,isMobileInsightAll=!1;function checkInsight(i,t){joinedTime<1?alertnew("此问卷暂时还没有答卷，不能生成AI报告!"):i?insightDeclare?getInsightScoreData():checkInsightAgreement(function(){insightDeclare=1,getInsightScoreData()}):(toInsightDiv(1),quesArr.length?isAIshowstyle?insightDeclare||-1<location.href.indexOf("isagree=1")?(window.isMobile&&($(".insightPart1,.insightPart2,.mask").hide(),$(".insightPart3").show()),getaitotal("生成AI报告",function(){insightAll($("#insight-all .startInsightBtn")[0])},"all")):checkInsightAgreement(function(){getaitotal("生成AI报告",function(){insightAll($("#insight-all .startInsightBtn")[0])},"all")}):insightDeclare?-1<location.href.indexOf("?")?location.href+="&isai=1":location.href+="?isai=1":checkInsightAgreement(function(){-1<location.href.indexOf("?")?location.href+="&isai=1&isagree=1":location.href+="?isai=1&isagree=1"}):alertnew("当前没有可以AI分析的题目，详情请查看详细说明文档。"))}function getInsightScoreData(){var i=scoreData.split(";"),t="",e=$(".sameScore span").text().split("/"),n=$(".peoNum span").text(),t=(t=t+("试卷满分："+(e[1]||"100")+"¤")+("参考人数："+n+"¤"))+("平均分："+e[0]+"¤成绩分布如下表¤")+"§分数段§人数§¤§----§----§¤";i.forEach(function(i){i=i.split(",");t+="§"+i[0]+"§"+i[1]+"§¤"}),GetInsightResult("score",t,1,1)}function disagreeInsight(){$(".mask").hide(),$("#moInsightAgreement").css("opactiy","0").hide(),$(".insightPart1").show(),$(".insightPart2").hide(),$(".insightPart3").hide(),$(".pop-up-layer").hide(),$("body").css("overflow","auto"),$(".layui-layer-shade,.layui-layer-move").remove()}function checkInsightAgreement(t){if(window.isMobile){var i;if(4==window.insightSign)i=document.documentElement.clientWidth-20,layer.open({zIndex:20201,fixed:!0,anim:2,resize:!1,scrollbar:!0,content:$("#InsightAgreement"),shade:.65,area:[i+"px",160+i+"px"],title:"AI分析数据授权协议",type:1,end:null,shadeClose:!0,btn:["同意","取消"],yes:function(i){insightDeclare=1,t(),$("#InsightAgreement").hide(),layer.close(i)},btn2:function(i){layer.close(i),$("#InsightAgreement").hide()}});else{if(isMobileInsightAll)return toInsightDiv(1);$(".insightPart3").hide(),$(".insightPart1").show(),$(".mask").show(),$("#moInsightAgreement").fadeIn("1000").css({bottom:"-85vh"}).animate({bottom:"0",opacity:"1"},500)}}else layer.open({type:1,title:"AI报告数据授权协议",closeBtn:1,area:["560px"," 650px"],offset:"auto",shade:.65,btn:["同意","取消"],yes:function(i){insightDeclare=1,t(),layer.close(i),$("#InsightAgreement").hide()},btn2:function(i){layer.close(i),$("#InsightAgreement").hide()},content:$("#InsightAgreement")})}function toInsightDiv(i){if(isMobileInsightAll)return $(".mask").show(),$(".insightPart1, .insightPart2").hide(),$(".insightPart3").show(),$("#moInsightAgreement").fadeIn("1000").css({bottom:"-95vh"}).animate({bottom:"0",opacity:"1"},1100,function(){$(".insightPart2").css("display","none")}),$(".pop-up-layer").hide(),isMobileInsightAll=!1;var t={},e="",n="",a=null,s=null,o="",l="",r="",d=(quesArr=[],[3,4,5,6].includes(window.insightSign)?[3,5].includes(window.insightSign)?$(".cross-container").each(function(i){t={},n=$(this).find("b[class='vam']").text()||$(this).find("div.dataItemTitle").text(),e=$(this).attr("tid")||-1*(i+1),a=$(this).find("table"),s=getInsightTable(a),o=e+"‡"+window.qCond+"‡"+window.eCond,l=hashTagObj[o],r=GetMdTable(n,s),t.qtitle=n,t.qi=e,t.mdTablestring=r,t.container=$(this).find(".table_scroll"),t.qi=e,t.keyInsight=o,t.desc=l?1:0,t.joinT=l?l.split("‡")[1]:"",r&&quesArr.push(t)}):4==window.insightSign?$(getContainer()).each(function(i){(objList=factorTitleObj($(this),i)).forEach(function(i){i.mdTablestring&&quesArr.push(i)})}):6==window.insightSign&&$(".dataItem").each(function(i){t={},n=$(this).find("b[class='vam']").text()||$(this).find("div.dataItemTitle").text(),e=i+1,a=$(this).find("table"),s=getInsightTable(a),o=e+"‡"+window.qCond+"‡"+window.eCond,l=hashTagObj[o],r=GetMdTable(n,s),t.qtitle=n,t.qi=e,t.mdTablestring=r,t.container=$(this).find("table"),t.qi=e,t.keyInsight=o,t.desc=l?1:0,t.joinT=l?l.split("‡")[1]:"",r&&quesArr.push(t)}):$(".title-item").each(function(){t={};var i=$(this).attr("type");"radio"!=i&&"check"!=i&&"matrix"!=i&&"radio_down"!=i&&2!=window.insightSign||(a=$(this).find("table"),s=getInsightTable(a),1==window.insightSign?(n=$(this).find(".title dd").text(),t.qtitle=n,e=$(s).attr("qi")):2==window.insightSign&&(n=$(this).attr("qtitle"),t.qtitle=1<$(".title-item").length?$(this).index()+1+". "+n+"("+$(this).find(".title dd").text()+")":n,e=$(this).attr("yqindex")),o=e+"‡"+window.qCond+"‡"+window.eCond,l=hashTagObj[o],r=GetMdTable(n,s),t.mdTablestring=r,t.container=$(this).find(".fillet__chart--dataGraph"),t.qi=e,t.keyInsight=o,t.desc=l?1:0,t.joinT=l?l.split("‡")[1]:"",r&&quesArr.push(t))}),"");quesArr.forEach(function(i){if(i.container.length){var t=window.isMobile?" onmouseenter='insightTips(this)'":"",e=window.isMobile?"class='mobileQtitle'":"";switch(d+="<tr>",window.insightSign){case 1:d+="<td style='text-align:center;'>"+i.qi/1e4+"</td>";break;case 4:(i.qtitle.endsWith("维度")||i.qtitle.endsWith("占比"))&&(i.qtitle=i.qtitle+"得分");var n=returnReportName(i.container).replace(/[\uE000-\uF8FF]/g,"");d+="<td style='text-align:center;'>"+n+"</td>";break;case 5:n=$(i.container).closest("div.factor-item").find("div.dataItemTitle").text();d+="<td style='text-align:center;'>"+-1*i.qi+"</td>";break;case 6:d+="<td style='text-align:center;'>"+i.qi+"</td>"}d+="<td "+e+" title='"+i.qtitle+"' "+t+">"+i.qtitle+"</td><td style='text-align:center' insightqi='"+i.qi+"'>",i.joinT&&i.joinT!=joinedTime||updateObj[i.qi]?d+="<span class='ins1' style='color:#0095ff;cursor:pointer' onclick='showInsightDetail(\""+i.qi+"\",2)'>更新</span>":i.desc?d+="<span class='ins1' style='color:#0095ff;cursor:pointer' onclick='showInsightDetail(\""+i.qi+"\",1)'>查看结果</span>":d+="<span class='ins1' style='color:#0095ff;cursor:pointer' onclick='showInsightDetail(\""+i.qi+"\",2)'>开始洞察</span>",d=d+"<img class='ins2' style='display:none' src='/images/comImg/loading.gif' width='20' height='20' alt=''>"+"</td></tr>"}}),$("#insightDiv").find("tbody").html(d),i||($("#insightDiv").show(),$(".pagebottomheight").hide())}function GetMdTable(i,t,e){if(!t)return!1;for(var n=i+"¤",a=t.rows,s=0;s<a.length;s++){var o=a[s];"none"!=o.style.display&&(n+=getTableRowsData(o,s,e))}return n}function getTableRowsData(i,t,e){var n="",a=i.cells;if(e&&e.isNps&&(a=Array.from(i.cells),0===e.type?a.splice(5):a.splice(1,4),i.cells=a),1==t){for(var s=0;s<a.length;s++)n+="§----";n+="§¤"}for(var o=0;o<a.length;o++)n+="|"+a[o].textContent;return n+="§¤"}function getSpssTableData(i,t,e){var n="",a="",s="|参数|值|¤",o=0;if(2==i){for(var l=0,r=0;r<t[0].cells.length;r++)-1<t[0].cells[r].textContent.indexOf("因子")&&l++;n+="抽取因子数量"+l+"¤",$(e).find("tr").each(function(){"KMO值"==$(this).find("td").eq(0).text()&&(o=$(this).index())});for(var d=0;d<t.length;d++)"none"!=(p=t[d]).style.display&&(v=getTableRowsData(p,d),d<o?a+=v:s+=v);n+=a+"¤"+s}else if(4==i||5==i){var c="",h="",g=$(e).closest(".cross-container").find(".controlAnalysis").attr("tq");if(2==(g=g.split("┋")).length){g[0].split(",").forEach(function(t,i){var e=spssquestions.filter(function(i){return i.QuestionIndex==t});e.length&&(c+="自变量"+(i+1)+"："+e[0].Title+"¤")});var f=spssquestions.filter(function(i){return i.QuestionIndex==g[1]}),u=(f.length&&(h+="因变量："+f[0].Title+"¤"),n+=h+c+"¤",4==i?"样本量":"F"),w=4==i?t.length-1:t.length;$(e).find("tr").each(function(){$(this).find("td").eq(0).text()==u&&(o=$(this).index())});for(var p,v,d=0;d<w;d++)"none"!=(p=t[d]).style.display&&(v=getTableRowsData(p,d),d<o?a+=v:s+=v);n+=a+"¤"+s}}return n}function getScoreCond(){var i=location.href.split("/").pop(),t=(i=i.split(".aspx")[0]).split(",");return i=1<t.length?t[1]:t[0]}function GetInsightResult(n,i,a,s,o,t,e){if(!isStopInsight||s){if("score"==n){var l=getScoreCond(),r="gradedistribution";n=$(".markScatter")}else{r=n.closest(".title-item").attr("type"),l=n.closest(".title-item").find("table").attr("qi");if(2==window.insightSign)r="cross";else if(3==window.insightSign){var d=n.closest(".cross-container").attr("at");switch(l=n.closest(".cross-container").attr("tid"),d){case"1":r="reliability";break;case"2":r="validity";break;case"3":r="relate";break;case"4":r="regress";break;case"5":r="anova"}}else[4,5,6].includes(window.insightSign)&&(d=window.document.title,r=-1<d.indexOf("满意度")?"satisfaction":"engagement",l=5==window.insightSign&&0<t?-1*t:t)}layer.load(1);d={activityid:activityId,content:encodeURI(i),q:l,qtype:r,qCond:window.qCond,eCond:window.eCond,instant:a,streaming:1};$.ajax({type:"post",data:d,dataType:"json",url:"/Handler/OpenAI/AICreate.aspx?action=insightSubject&taskType=4&activityid="+activityId,success:function(i){var t,e;layer.closeAll("loading"),quesRes=i.code,1==a&&(0==i.code&&i.data?(LoagInsight("",n,l),i.data=JSON.parse(i.data),t={key:i.data.taskId,activityid:activityId,q:l,qtype:r,qCond:window.qCond,eCond:window.eCond},insightAllStateSwitch("doing"),e=setInterval(function(){$.ajax({url:"/Handler/OpenAI/AICreate.aspx?action=getInsightResult&taskType=4",method:"GET",data:t,dataType:"json",success:function(i){var t;i.data&&1008!==i.code?0==i.code&&(updateObj[l]=!1,clearInterval(e),t=l+"‡"+window.qCond+"‡"+window.eCond,hashTagObj[t]=i.data+"‡"+joinedTime,"请求数据超过最大token数，请调整数据大小后再次尝试！"==i.data?i.data="内容过多，暂不支持AI分析!":3<=finishiall?$(".insight_isdoing").remove():addDoingTip(),LoagInsight(i.data,n,l),quesRes=1e4,o)&&o():1008!==i.code&&(clearInterval(e),LoagInsight(3,n,l),s&&layer.msg("AI分析失败，请重试！"),quesRes=10001,o)&&o()}})},3e3)):1e3==i.code||1014==i.code||1004==i.code||1006==i.code||1011==i.code?($("td[insightqi="+l+"]").find(".ins1").show(),$("td[insightqi="+l+"]").find(".ins2").hide(),1006==i.code||s?(layer.msg(i.msg),$(".ins1").show(),$(".ins2").hide(),isInsighting=!1,$(".startInsightBtn").text("开始生成AI报告")):(1011==i.code&&s&&layer.msg(i.msg),o&&o())):(LoagInsight(3,n,l),s&&($("td[insightqi="+l+"]").find(".ins1").show(),$("td[insightqi="+l+"]").find(".ins2").hide(),layer.msg("AI生成失败，请重试！")),quesRes=10001,o&&o()))}})}}function LoagInsight(i,t,e){var n,a="<div style='clear:both;'></div>",s="",o="copyDongcha"+t.closest(".title-item").find("table[qi]").attr("qi"),l=(t.hasClass("markScatter")&&(s="scoreClass",o="copyDongchaScore"),3==window.insightSign&&(o=t.closest(".cross-container").attr("tid")),window.isMobile?"<div class='dongchaOpera' onclick='showDongchaOpera(this)'><img src='/images/weixin/mobile/insightmore.png'></div>":"<div class='dongchaIcon'><i  title='刷新' onclick='refreshInsight(this)' style='font-size:16px;color:#0095ff;cursor:pointer;'>重新生成</i></div>"),l="<div class='dongchaIcon' dignore='1'><i  title='刷新' onclick='refreshInsight(this)' style='font-size:14px;color:#0095ff;cursor:pointer;'>重新生成</i><i onclick='showImgBtn(this)' style='font-size:14px;color:#0095ff;cursor:pointer;'>调整图表</i></div>",r=(i?(n=!1,!window.isShare||3!=i&&"waiting"!=i&&"none"!=i?"waiting"==(i=3==i?"AI分析失败，请重试!":i)?i="该题AI分析结果生成失败，请点击重新生成按钮重试!(注：失败不会扣除AI点数)":"none"==i?i="该题AI分析结果尚未生成，请点击重新生成按钮重试!(注：未生成不会扣除AI点数)":(i=parseMarkDown(i),n=!0):i="",!window.isShare&&-1!=window.quesId||(l="<div class='dongchaIcon' dignore='1'><i onclick='showImgBtn(this)' style='font-size:14px;color:#0095ff;cursor:pointer;'>调整图表</i></div>"),a+="<div export="+([4,5,6].includes(window.insightSign)?"0":"1")+" export-item="+(n?"1":"0")+" class='dongchaDiv "+s+"' onmouseenter='showDongchaIcon(this)' onmouseleave='hideDongchaIcon(this)' style=''><span id='"+o+"' export-split='1'>"+i+"</span>"+l+"</div>"):a+="<div class='dongchaDiv dongchaLoadingDiv' ><img src='/images/comImg/loading.gif' width='40' height='40' alt=''></div>",t.closest(".title-item"));switch(t.is(".markScatter")&&(r=t.parent()),window.insightSign){case 4:(t.is(".sic_wrap")?(t.next().next(".dongchaDiv").remove(),t):(r.find(".sic_wrap").eq(0).next().next(".dongchaDiv").remove(),r.find(".sic_wrap").eq(0))).after($(a));break;case 6:(r=r.is(".dataItem")?r:r.closest(".dataItem")).next("div:not([class])").remove(),r.next("div.dongchaDiv").remove(),r.after($(a));break;default:r.find(".dongchaDiv").remove(),3==window.insightSign?t.css("marginBottom","0").after(a):t.hasClass("markScatter")?t.after(a):(r.find(".title").after(a),r.addClass("aititle-item"))}e&&i&&((n=$("td[insightqi="+e+"]")).find(".ins1").remove(),n.prepend("<span class='ins1' style='color:#0095ff;cursor:pointer' onclick='showInsightDetail(\""+e+"\",1)'>查看结果</span>"),n.find(".ins1").show(),n.find(".ins2").hide())}function showDongchaOpera(i){curDongchaArea=$(i).closest(".dongchaDiv"),$(".mask").css("position","fixed").show();i=-$(".pop-up-layer-dongcha").height()+"px";$(".pop-up-layer-dongcha").css("bottom",i),$(".pop-up-layer-dongcha").animate({bottom:0},100,"linear").show(),$("body").css({overflow:"hidden"}),$(".lookDetail").hide()}function showDongchaIcon(i){window.isShare}function hideDongchaIcon(i){}function getInsightTable(i){var t;if(i.length)return"table"==i[0].tagName.toLowerCase()?i[0]:!(t=(t=(t=i[0].children[0])&&"table"==t.tagName.toLowerCase()?t:i[0].children[0].children[0])&&"table"==t.tagName.toLowerCase()?t:i[0].children[1].children[0])||"table"!=t.tagName.toLowerCase()&&i[0].children[2]?i[0].children[2].children[0]:t}function refreshInsight(i){var t,e,n,a,s;curDongchaArea=$(i).closest(".dongchaDiv"),$(i).closest(".dongchaDiv").hasClass("scoreClass")?getInsightScoreData():(t=(window.isMobile?curDongchaArea:$(i).parent().parent()).parent().find(".fillet__chart--dataGraph"),e=(t=3==window.insightSign?$(i).closest(".cross-container").find(".table_scroll"):t).parent().find(".title dd").text(),4==window.insightSign?(t=$(i).closest("div.dongchaDiv").prev().prev("div.sic_wrap"),e=(t=window.isMobile?curDongchaArea.prev().prev():t).parent().prev().text(),n={isNps:1<t.parent().find("div.sic_wrap").length,type:t.nextAll("div.dongchaDiv").length-1},a=returnSatisfactionQi(t)):5==window.insightSign?(e=(t=t.closest("div.radiu-box").find("div.table_scroll")).parent().prev("div.dataItemTitle").text(),a=t.parent().index()):6==window.insightSign&&(e=(t=$(i).closest("div.dongchaDiv").prev().prev("div.dataItem").find("table")).prev(".dataItemTitle").text(),a=$("div.dataItem").get().indexOf(t.parent()[0])+1,e||a||(e=t.parent().prev(".dataItemTitle").text(),a=$("div.dataItem").get().indexOf(t.parent().parent()[0])+1)),i=getInsightTable(t.parent().find("table")),s=GetMdTable(e,i,n),getaitotal("重新生成所选题目",function(){GetInsightResult(t,s,1,1,null,a,1)}),window.isMobile&&hideSheet())}function insightDataCopy(){var i="",t="",e=window.insightSign,t=null;if([4,5,6].includes(e)){var n,a,s=getContainer();for([n,a]of Object.entries(hashTagObj).sort(function(i,t){i=+i[0].split("‡")[0],t=+t[0].split("‡")[0];return i<0&&(i*=-1),t<0&&(t*=-1),1e6<i&&(i/=1e3),1e6<t&&(t/=1e3),i-t})){var o=window.qCond+"‡"+window.eCond;if("‡"!=o){if(!n.includes(o))continue}else if(!n.includes("‡‡")||n.includes("§"))continue;var l=Number(n.split("‡")[0]);if(!isNaN(l)){switch(e){case 4:var r=findContainer(l,s).text();break;case 5:r=$("div.dataItemTitle").eq(-1*l).text();break;case 6:r=$("div.dataItemTitle").eq(l-1).text()}i+=r+"\n"+hashTagObj[n].split("‡")[0]+"\r"}}}else[1,2].includes(e)?t=$(".title-item"):3==e&&(t=$(".cross-container")),i=returnText(t);copy(i)}function copy(i){$("body").append("<textarea id='copyInsight'/>"),$("#copyInsight").val(i.replace(/\n+/g,"\n")).select(),document.execCommand("copy"),$("#copyInsight").remove(),layer.msg("复制成功"),window.isMobile&&hideSheet()}function returnText(i){var t="";return $(".scoreClass").length&&(t+=$(".scoreClass:first>span").text()+"\r"),i.each(function(){var i;$(this).find(".dongchaDiv:first").length&&(i=(3==window.insightSign?$(this).find("b[class='vam']"):$(this).find(".title")).text(),t+=i+"\n"+$(this).find(".dongchaDiv:first>span").text()+"\r")}),t}function copyDongcha(i){if(window.clipboardData){var t=(window.isMobile?curDongchaArea.find("span"):$(i).parent().prev()).text();window.clipboardData.setData("text",t),layer.msg("复制成功")}else try{t=(4==window.insightSign?$(i).closest(".dongchaDiv ").find("span"):$(i).closest(".title-item").find(".dongchaDiv:first>span")).text(),$(i).closest(".dongchaDiv").hasClass("scoreClass")&&(t=$(".scoreClass:first>span").text()),3==window.insightSign&&(t=$(i).closest(".cross-container").find(".dongchaDiv:first>span").text()),window.isMobile&&(t=curDongchaArea.find("span").text()),$("body").append("<textarea id='copyInsightSingle' style='user-select:auto'/>"),$("#copyInsightSingle").val(t.replace(/\n+/g,"\n")).select(),document.execCommand("copy"),$("#copyInsightSingle").remove(),layer.msg("复制成功"),window.isMobile&&hideSheet()}catch(i){alert("复制失败，请手动复制！")}}function delInsight(t,e){confirmnew("确认删除吗？",function(){var i=(t?$(t):curDongchaArea).closest(".title-item").find("table[qi]").attr("qi");switch(window.insightSign){case 3:i=$(t).closest(".cross-container").attr("tid");break;case 4:i=returnSatisfactionQi($(t).closest("div.dongchaDiv").prev().prev("div.sic_wrap"));break;case 5:i=returnReportsummaryanalysisQi($(t)).toString();break;case 6:i=returnMjlistQi($(t)).toString()}window.isMobile&&(t=curDongchaArea.find(".dongchaOpera")),$(t).closest(".dongchaDiv").hasClass("scoreClass")&&(i=getScoreCond()),delInsightAction(i=e?e+"":i,t)})}function delAllInsight(){if(isInsighting)return layer.msg("正在生成AI中，请先停止生成"),!1;for(var i=[],t=$("#insightDiv td[insightqi]"),e=0;e<t.length;e++){var n=t[e],n=$(n).attr("insightqi"),a=n+"‡"+window.qCond+"‡"+window.eCond;hashTagObj[a]&&i.push(n)}return 0!=i.length&&delInsightAction(i.join(","),null),!0}function delInsightAction(i,n,a){var t="/Handler/SetTagDataCache.aspx?option=ClearInsightResult&qindex="+i+"&qCond="+encodeURIComponent(window.qCond)+"&econd="+encodeURIComponent(window.eCond),s=i.split(","),o=i+"‡"+window.qCond+"‡"+window.eCond;$.post(t,{activityId:activityId},function(i){if("ok"==i){if(a)return a();(n?$(n).closest(".dongchaDiv"):$(".dongchaDiv")).remove();for(var t=0;t<s.length;t++){var e=s[t];o=e+"‡"+window.qCond+"‡"+window.eCond,hashTagObj[o]="",$("td[insightqi="+e+"]").find(".ins1").remove(),$("td[insightqi="+e+"]").prepend("<span class='ins1' style='color:#0095ff;cursor:pointer' onclick='showInsightDetail(\""+e+"\",2)'>开始生成AI报告</span>")}0==$(".dongchaDiv").length&&insightAllStateSwitch("todo"),window.isMobile&&n&&hideSheet()}else layer.msg("删除失败!")})}function stopInsight(){isInsighting=!(isStopInsight=!0),$(".ins1").show(),$(".ins2").hide()}function insightTips(i){layer.tips($(i).attr("title"),i,{tips:[1],area:"auto"})}function showInsightDetail(t,i,e){var n=quesArr.filter(function(i){return i.qi==t});if(n.length){var{keyInsight:n,container:a,mdTablestring:s}=n[0];if(1===i){if(e)return e();var n=hashTagObj[n].split("‡")[0],n=("请求数据超过最大token数，请调整数据大小后再次尝试！"==(displayResult="waiting"===n?"AI报告生成失败!":n)&&(displayResult="提交内容过多，暂不支持AI分析"),$(".insightDetail_text").html(parseMarkDown(displayResult)),window.isMobile?300:465),o=window.isMobile?400:300;PDF_launch("insightDetail",n,o,function(){$("#insightDetail").hide()},"AI分析详情")}else 2==i&&($("td[insightqi="+t+"]").find(".ins1").hide(),$("td[insightqi="+t+"]").find(".ins2").show(),GetInsightResult(a,s,1,1,function(){10001==quesRes?alertnew("AI报告生成过程中发生错误，请重试!",function(){isInsighting=!1,$(".ins1").show(),$(".ins2").hide(),layer.closeAll()}):e&&e()},t))}}function insightAll(i,t){t?($(i).text("开始AI生成").attr("onclick","insightAll(this)"),isStopInsight=!0):($(i).text("停止AI生成").attr("onclick","insightAll(this,1)"),isStopInsight=!1,0<$("#insightDiv table tr").length&&(finishiall=0,startInsightAll("gloanalypreface"),startInsightAll("gloanalysummary"))),allInsight(1)}function bindInsightData(i){var t,e=$(".cross-container[tid='"+i+"']");e.length&&(t=i+"‡"+window.qCond+"‡"+window.eCond,t=hashTagObj[t])&&(t=t.split("‡"),e=e.find(".table_scroll"),2==t.length&&LoagInsight(t[0],e),updateObj[i]=!0)}function returnReportName(i){return i.closest(".dataItem").find("div.dateItemTitleContainer").text()||"综合结果"}function factorTitleObj(i,t){var e=[],n=(tableDom=i.next().find("table")).find("th");if(n.length)for(var a=7<n.length&&"满意度总体得分"==n.eq(-1).text()?2:1,s=0;s<a;s++){var o={},l=i.attr("qindex")?Number(i.attr("qindex"))+s:10*t+1,r=1e3*l+"‡"+window.qCond+"‡"+window.eCond,d=hashTagObj[r];o.qtitle=i.text(),2==a&&(o.qtitle+=0===s?"—NPS相关图表":"—满意度相关图表"),o.mdTablestring=GetMdTable(i.text(),getInsightTable(tableDom),{isNps:2==a,type:s}),o.container=tableDom.parent().parent().find("div.sic_wrap").eq(s),o.qi=1e3*l,o.keyInsight=r,o.desc=d?1:0,o.joinT=d?d.split("‡")[1]:"",e.push(o)}return e}function renderSatisfaction(i){for(var t=Object.keys(hashTagObj),e=getContainer(),n=window.qCond+"‡"+window.eCond,a=0;a<t.length;a++){var s,o=t[a];!o.includes(n)||"‡"==n&&o.includes("§")||(s=Number(o.split("‡")[0])/1e3,isNaN(s))||(s=findContainer(s,e),LoagInsight(hashTagObj[o].split("‡")[0],s))}window.isShare&&$("#insightBtn,.dongchaOpera,#checkInsightBtn").hide()}function findContainer(e,i){var t=null,i=(1e3<=e&&e%1e3==0?t=function(i){return $(i).attr("qindex")==e}:1e3<=e&&e%1e3!=0?(e+="_1",t=function(i){return-1<e.indexOf($(i).attr("qindex")/10)}):e<1e3&&(e=Math.floor(e/10),t=function(i,t){return t==e}),$(i.filter(t)[0]));return i="string"==typeof e&&-1<e.indexOf("_")?i.next().find("div.sic_wrap").eq(1):i}function getContainer(){return $(".factor-title").get().filter(function(i){return $(i).next().find("table").length})}function returnSatisfactionQi(i){var t=getContainer(),e=i.closest("div.factor-item").find("div.factor-title").attr("qindex"),n=i.find("div.divResultCss").attr("id"),a=0;return e?a=i.prevAll("div.sic_wrap").length?Number(e)+1:e:t.some(function(i,t){if($(i).parent().find("div#"+n).length)return a=10*t+1,!0}),(1e3*a).toString()}function allInsight(i,t){var e,n;isStopInsight||(e=$("#insightDiv table tr"),i<e.length?showInsightDetail((n=e.eq(i).find("td:last")).attr("insightqi"),"查看结果"==n.find("span").text()?1:2,function(){i+1==e.length&&finishiall++,allInsight(i+1)}):3==finishiall&&(insightAllStateSwitch("done"),$(".insight_isdoing").remove(),isStopInsight=!0))}function returnReportsummaryanalysisQi(i){return-1*i.parents("div.dataItem").prevAll("div.dataItem").length}function returnMjlistQi(i){return $("div.dataItem").get().indexOf(i.closest("div.dongchaDiv").prev().prev("div.dataItem")[0])+1}function insightTabsSwitchInit(){$("#insightDiv .insight-tabs").on("click","li",function(){var i=$(this).index();$(this).siblings().find("a").removeClass("cur"),$(this).find("a").addClass("cur"),$("#insightDiv .insight-tabs-content").removeClass("active"),$("#insightDiv .insight-tabs-content").eq(i).addClass("active")})}function checkHasInsightAllResult(){var i=10*activityId,i=hashTagObj[i+"‡"+window.qCond+"‡"+window.eCond],i=(i&&(i.startsWith("waiting")?window.isShare||showInsightAllResult('"前言概述"部分生成失败，请点击重新生成按钮重试',"top"):showInsightAllResult(i,"top")),10*activityId+1),i=hashTagObj[i+"‡"+window.qCond+"‡"+window.eCond];i&&(i.startsWith("waiting")?window.isShare||showInsightAllResult('"结论"部分生成失败，请点击重新生成按钮重试',"bottom"):showInsightAllResult(i,"bottom"))}function getQuestionList(){var s=[],o=["radio","check","radio_down","matrix","sum"],l=["question"],r=["[表格文本题]","[矩阵文本题]"];return $("#divSumData .title-item, #divStatData .title-item").each(function(i,t){var t=$(t),e=t.attr("type");if(o.includes(e)||l.includes(e)){var n={type:e,question:t.find(".title").text().trim()};if(o.includes(e)){var a=t.find(".title span:last").text();if(r.includes(a))return;n.qi=t.find(".wjxui-table").attr("qi"),n.tableData=Array.from(t.find(".wjxui-table:first tr")).map(function(i){return Array.from($(i).find("td")).map(function(i){return $(i).text()})})}else if(l.includes(e)){n.qi=t.find(".chartBtn").attr("qi");a=hashTagObj[n.qi];if(!a)return;e=a.split("¤")[0];if(e.length<=5)return;n.tableData=[["词汇","频数"]],e.split("|").forEach(function(i){n.tableData.push(i.split(",").splice(0,2))})}s.push(n)}}),s}function getInsightAllReqMd(i){var a=`## 一、问卷内容
`,s=`## 二、统计结果
`,t=getQuestionList(),o=["radio","check","radio_down"];return t.forEach(function(i,t){var n=i.question+"\n",e=(i.tableData&&o.includes(i.type)&&i.tableData.forEach(function(i,t){0!==t&&"本题有效填写人次"!==i[0]&&(n+=i[0]+"\n")}),i.tableData&&"matrix"===i.type&&i.tableData.forEach(function(i,e){n+="|"+i.map(function(i,t){return 0===e||0===t?i:""}).join("|")+"|\n",0===e&&(n+="|"+i.map(function(){return"----"}).join("|")+"|\n")}),i.question+"\n");i.tableData&&i.tableData.forEach(function(i,t){e+="|"+i.join("|")+"|\n",0===t&&(e+="|"+i.map(function(){return"----"}).join("|")+"|\n")}),a+=n+"\n",s+=e+"\n"}),i?a+"\n"+s:a}function insightAllInit(i){var e=i,i=(layer.load(1),"gloanalypreface"==e?10*activityId:10*activityId+1),t="",t="gloanalypreface"==e?getInsightAllReqMd():getInsightAllReqMd(1),t={activityid:activityId,content:encodeURI(t),q:i,qtype:e,qCond:window.qCond,eCond:window.eCond,instant:1,streaming:1};$.ajax({type:"post",data:t,dataType:"json",url:"/Handler/OpenAI/AICreate.aspx?action=insightSubject&taskType=4&activityid="+activityId,success:function(i){var t;layer.closeAll("loading"),i.data&&(i.data=JSON.parse(i.data)),0==i.code&&i.data&&i.data.taskId?(t=i.data.taskId,"gloanalypreface"==e&&0<$(".before_aiword").length?$(".before_aiword").html("<div class='dongchaDiv dongchaLoadingDiv' ><img src='/images/comImg/loading.gif' width='40' height='40' alt=''></div>"):"gloanalysummary"==e&&0<$(".conclusion").length?$(".conclusion").html("<div class='dongchaDiv dongchaLoadingDiv' ><img src='/images/comImg/loading.gif' width='40' height='40' alt=''></div>"):insightAllStateSwitch("doing"),setTimeout(function(){getInsightAllResultByTaskId(t,e)},2e3)):alert(i.msg)}})}function startInsightAll(i,t){t?getaitotal("gloanalypreface"==i?"重新生成“前言概述”":"重新生成“结论”",function(){insightAllInit(i)},i):insightAllInit(i)}function getInsightAllResultByTaskId(e,n){var i="gloanalypreface"==n?10*activityId:10*activityId+1,i={key:e,activityid:activityId,q:i,qtype:n,qCond:window.qCond,eCond:window.eCond},a=n;$.ajax({url:"/Handler/OpenAI/AICreate.aspx?action=getInsightResult&taskType=4",method:"GET",data:i,dataType:"json",success:function(i){var t;1008===i.code?setTimeout(function(){getInsightAllResultByTaskId(e,a)},3e3):i.data?1010==i.code?(istimeout=!1,showInsightAllResult(t=(t=i.data.split("┋"))[t.length-1],"gloanalypreface"==a?"top":"bottom"),setTimeout(function(){getInsightAllResultByTaskId(e,a)},3e3)):(finishiall++,showInsightAllResult(i.data,"gloanalypreface"==n?"top":"bottom"),3<=finishiall?$(".insight_isdoing").remove():addDoingTip()):1009!=i.code&&-1!=i.code&&1001!=i.code||layer.msg(i.data)}})}function addDoingTip(){0==$(".insight_isdoing").length&&(insightAllStateSwitch("done"),$(".report-title").before(`<div class="insight_isdoing" style="">
        <p style="color:#262626;">AI报告生成用时较长，<b style="color:red;">请不要离开此页面或者刷新页面</b>，感谢您的耐心等待。<span style='font-weight:600;'></span></p>
    </div>`))}function parseMarkDown(i){i=i.replace(/###?\s*(.*?)\n/gi,"<b style='color:#262626;font-size:16px;'>$1</b>\n");return i=(i=i.replace(/\*\*(.*?)\*\*/gi,"<b>$1</b>").replace(/\-\s*(.*?)\n/gi," $1\n")).replace(/\\n/gi,"<br/>").replace(/\n/gi,"<br/>")}function showInsightAllResult(i,t){var i=parseMarkDown(i=i.replace(/‡\d+$/,"")),e="top"==t?10*activityId:10*activityId+1,n=`<div export="1" export-item="1" class="dongchaDiv" ${window.isMobile?"style='padding-top:6px;'":""} ><span id="copyDongcha${e}" export-split="1">${i}
</span><div class="dongchaIcon"   dignore='1' style="top:-20px;"><i  title="刷新" onclick="startInsightAll('${"top"==t?"gloanalypreface":"gloanalysummary"}',1)" style="font-size:14px;color:#0095ff;">重新生成</i></div></div>`;window.isShare&&(n=`<div export="1" export-item="1" class="dongchaDiv" ><span id="copyDongcha${e}" export-split="1">${i}
</span></div>`),"top"==t?0<$(".before_aiword").length?$(".before_aiword").html(n):window.isShare&&0<$(".title-item").length?$(".title-item").eq(0).before("<div class='before_aiword conclusion_style title-item'>"+n+"</div>"):$(".report-title").after("<div class='before_aiword conclusion_style title-item'>"+n+"</div>"):0<$(".conclusion").length?$(".conclusion").html(n):window.isMobile&&0<$(".title-item").length?$(".title-item").eq($(".title-item").length-1).after("<div class='conclusion conclusion_style title-item'>"+n+"</div>"):$(".pagebottom").before("<div class='conclusion conclusion_style title-item'>"+n+"</div>")}function insightAllDataCopy(){var i=$("#insight-all .state-content").text();if(navigator.clipboard)navigator.clipboard.writeText(i).then(function(){layer.msg("复制成功！")},function(){layer.msg("复制失败！请手动复制")});else try{$("body").append("<textarea id='copyInsightSingle' style='user-select:auto'/>"),$("#copyInsightSingle").val(i.replace(/\n+/g,"\n")).select(),document.execCommand("copy"),$("#copyInsightSingle").remove(),layer.msg("复制成功"),window.isMobile&&hideSheet()}catch(i){alert("复制失败，请手动复制！")}}function insightAllDataDownload(){GenerateReport(1)}function InsightAllDataDelete(){confirmnew("确认删除吗？",function(){toInsightDiv(1),delAllInsight()&&(delInsightAction(10*activityId+1+"",null,function(){}),delInsightAction(10*activityId+"",null,function(){}))})}function insightAllStateSwitch(i){var t;$("#insight-all>div").not("."+i).hide(),$("#insight-all>."+i).show(),clearInterval(insightAllLoadingInterval),"done"===i&&(window.isMobile?disagreeInsight():($("#divSumData").show(),$("#insightDiv").hide(),$(".pagebottomheight").show()),initAiUi()),"doing"===i&&(t=3,insightAllLoadingInterval=setInterval(function(){t=6<=t?1:t+1,$("#insight-all .doing h6").text("AI报告生成中"+".".repeat(t)),0<$(".insight_isdoing").length&&$(".insight_isdoing span").text("AI报告生成中"+".".repeat(t))},500)),"doing"===i&&$(".startInsightBtn").hide(),"todo"===i&&(window.isMobile?window.location.reload():($("#divSumData").hide(),toInsightDiv(),$(".startInsightBtn").text("生成AI报告").show()))}function initAiUi(i){(isAIshowstyle||window.isMobile)&&(window.isMobile?($("#divStatData").addClass("aibg aibgmobile"),$(".outer_ai").css({margin:0,padding:"10px 15px"}).show(),$("#divMore").off("click"),$("#divMore").show(),$("#divMore").on("click ",function(){showDongchaOpera()}),$(".title-item").find("table").parent().parent().hide(),setTimeout(function(){$(".divResultCss ul").each(function(){$(this).find("li").eq(0).trigger("click")}),$(".chartControl,.divResultCss").hide()},300)):(window.isShare&&$(".dongcha_deletebtn").hide(),$(".dongcharight").addClass("wjxui-btn-rightsideGroup").show(),$(".sic_wrap").addClass("aibg"),$("#divSumData").show(),setTimeout(function(){$("#displayTable").prop("checked")&&Display($("#displayTable")[0],99),0==$("#htagWrap .radio-groups input:checked").length&&Display($("#tb-radio99")[0],99),$(".chartControl,.divResultCss").hide()},300)))}var totalAiAll="";function getaitotal(t,e,i){var n="gloanalysummary"==i?"2":"0.2";"all"==i&&(n=.2*quesArr.length,n=(n+=2.2).toFixed(1)),$.get("/handler/userspace.ashx?ai=1",function(i){i?(totalAiAll=i,isNaN(totalAiAll)||(totalAiAll=Number(totalAiAll).toFixed(1)),parseFloat(totalAiAll)<parseFloat(n)?alertNew("您的点数不足，无法生成"):(i=layer.confirm("您将"+t+"内容，本次生成消耗Ai点数<b style='color:red;'>"+n+"</b>，余额：<b style='color:red;'>"+totalAiAll+"</b>，确认后将进行"+t+"生成<div style='position: absolute; left: 20px; bottom: -46px;font-size: 12px;color:#8c8c8c'>生成失败的部分将不扣除AI点数</div>",{title:"生成提示"},function(i){e&&e(),layer.close(i)},function(i){layer.close(i)}),$("#layui-layer"+i).find(".layui-layer-content").css({overflow:"visible","overflow-x":"visible","overflow-y":"visible"}))):alertNew("未登录")})}function changeAiReport(){$("#divSumData").hide(),$(".fankui").hide(),$(".wjxui-btn-rightsideGroup").removeClass("wjxui-btn-rightsideGroup").addClass("wjxui-btn-rightsidehide").hide(),hashTagObj[10*activityId+1+"‡"+window.qCond+"‡"+window.eCond]||hashTagObj[10*activityId+"‡"+window.qCond+"‡"+window.eCond]||createAI?initAiUi():($("#divSumData").hide(),$("#insightDiv").show(),$(".pagebottomheight").hide())}function aiChangeOthter(){$(".wjxui-btn-rightsidehide").addClass("wjxui-btn-rightsideGroup").removeClass("wjxui-btn-rightsidehide").show(),$(".dongcharight").hide(),$(".aibg").removeClass("aibg"),$(".fankui").show()}function showImgBtn(i){$(i).closest(".title-item").find(".chartControl,.divResultCss").toggle()}function toCreateAi(){var i=location.href;-1<i.indexOf("?")&&(i+="&isai=1"),location.href=i}