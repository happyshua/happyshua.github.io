<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>LLMs Chat</title>
  <style>
    /* 你的现有CSS样式 */
    body {
      font-family: Arial, sans-serif;
    }
    #chatContainer {
      max-width: 600px;
      margin: auto;
    }
    #chatHistoryContainer {
      border: 1px solid #ccc;
      padding: 10px;
      height: 300px;
      overflow-y: scroll;
      margin-bottom: 10px;
    }
    .chat-message {
      margin-bottom: 10px;
    }
    .chat-message.user {
      text-align: right;
    }
    .chat-message.model {
      text-align: left;
    }
    #inputText {
      width: calc(100% - 70px);
      padding: 10px;
    }
    button {
      padding: 10px;
    }
  </style>
</head>
<body>
  <div id="app">
    <div id="chatContainer">
      <div id="chatHistoryContainer"></div>
      <input type="text" id="inputText" placeholder="Type your message here...">
      <button onclick="getResponses()">Send</button>
    </div>
    <div id="modelSelectContainer" style="display: none;">
      <h2>Select Models</h2>
      <ul id="modelList">
        <!-- Model checkboxes will be appended here -->
      </ul>
      <button onclick="updateSelectedModels()">Save Selection</button>
      <button onclick="toggleModelSelect()">Cancel</button>
    </div>
    <div id="historyModal" style="display: none;">
      <h2>Chat History</h2>
      <ul id="historyList">
        <!-- History items will be appended here -->
      </ul>
      <button onclick="toggleHistoryModal()">Close</button>
    </div>
    <button onclick="toggleModelSelect()">Select Models</button>
    <button onclick="newConversation()">New Conversation</button>
    <button onclick="exportChatHistory()">Export Current Chat</button>
    <button onclick="exportAllChatHistory()">Export All Chats</button>
    <button onclick="toggleHistoryModal()">View History</button>
  </div>

  <script>
    const models = [
      // 在这里配置你的模型
      { name: 'Model A', api_url: 'https://glmapi.xinu.ink/v1/chat/completions', api_key: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJmcmVzaCI6ZmFsc2UsImlhdCI6MTcxNDk1ODYwNSwianRpIjoiMGE2OWY2OTktYmQxZS00MWJmLWE5YzQtNTU5NDA3MWQ2MmY3IiwidHlwZSI6InJlZnJlc2giLCJzdWIiOiJkZGQ1MGUxMDAwYzk0OWNjYmY2ZDM3ZTNjNmViMTk1ZSIsIm5iZiI6MTcxNDk1ODYwNSwiZXhwIjoxNzMwNTEwNjA1LCJ1aWQiOiI2NjM4MzEwYzRkNTEwYmQ5ZWZhNGFiNGYiLCJ1cGxhdGZvcm0iOiJwYyIsInJvbGVzIjpbInVuYXV0aGVkX3VzZXIiXX0.agFeK5NnkIdMwEZ5CYmZYxP4SMg2kF42IvsOnE4B778' },
      { name: 'Model B', api_url: 'https://api.example.com/modelB', api_key: 'API_KEY_B' }
    ];
    let selectedModels = [];
    let chatHistory = [];
    let chatHistoryList = [];
    let showModelSelect = false;
    let showHistoryModal = false;

    document.addEventListener('DOMContentLoaded', () => {
      loadSelectedModels();
      loadChatHistoryList();
      updateModelSelectDisplay();
    });

    function loadChatHistoryList() {
      const storedChatHistoryList = localStorage.getItem('chatHistoryList');
      if (storedChatHistoryList) {
        chatHistoryList = JSON.parse(storedChatHistoryList);
      }
      updateHistoryListDisplay();
    }

    function saveChatHistory() {
      if (chatHistory.length === 0 || (chatHistory.length === 1 && !chatHistory[0].text)) {
        return; // 防止保存空的聊天记录或只有一条空白记录的聊天记录
      }
      const timestamp = new Date().toISOString();
      const preview = chatHistory.map(entry => entry.text).join(' ').slice(0, 100);
      chatHistoryList.push({ timestamp, preview, chatHistory: [...chatHistory] });
      localStorage.setItem('chatHistoryList', JSON.stringify(chatHistoryList));
    }

    function loadHistory(index) {
      const historyItem = chatHistoryList[index];
      chatHistory = historyItem.chatHistory;
      updateChatDisplay();
    }

    function newConversation() {
      if (chatHistory.length === 0 || (chatHistory.length === 1 && !chatHistory[0].text)) {
        return; // 防止新建空白会话
      }
      saveChatHistory();
      chatHistory = [];
      updateChatDisplay();
    }

    function exportChatHistory() {
      const text = chatHistory.map(entry => `[${entry.sender}]: ${entry.text}`).join('\n');
      downloadTextFile(text, 'chat_history.txt');
    }

    function exportAllChatHistory() {
      const allHistoriesText = chatHistoryList.map(history => {
        const header = `Chat at ${history.timestamp}`;
        const content = history.chatHistory.map(entry => `[${entry.sender}]: ${entry.text}`).join('\n');
        return `${header}\n${content}`;
      }).join('\n\n');
      downloadTextFile(allHistoriesText, 'all_chat_histories.txt');
    }

    function downloadTextFile(text, filename) {
      const element = document.createElement('a');
      element.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(text));
      element.setAttribute('download', filename);
      element.style.display = 'none';
      document.body.appendChild(element);
      element.click();
      document.body.removeChild(element);
    }

    function toggleModelSelect() {
      showModelSelect = !showModelSelect;
      updateModelSelectDisplay();
    }

    function updateModelSelectDisplay() {
      const modelSelectContainer = document.getElementById('modelSelectContainer');
      modelSelectContainer.style.display = showModelSelect ? 'block' : 'none';
      if (showModelSelect) {
        const modelList = document.getElementById('modelList');
        modelList.innerHTML = '';
        models.forEach((model, index) => {
          const listItem = document.createElement('li');
          const checkbox = document.createElement('input');
          checkbox.type = 'checkbox';
          checkbox.className = 'model-checkbox';
          checkbox.checked = selectedModels.includes(models[index]);
          checkbox.onchange = updateSelectedModels;
          listItem.appendChild(checkbox);
          listItem.appendChild(document.createTextNode(model.name));
          modelList.appendChild(listItem);
        });
      }
    }

    function updateSelectedModels() {
      const checkboxes = document.querySelectorAll('.model-checkbox');
      selectedModels = [];
      checkboxes.forEach((checkbox, index) => {
        if (checkbox.checked) {
          selectedModels.push(models[index]);
        }
      });
      saveSelectedModels();
    }

    function saveSelectedModels() {
      localStorage.setItem('selectedModels', JSON.stringify(selectedModels));
    }

    function loadSelectedModels() {
      const storedSelectedModels = localStorage.getItem('selectedModels');
      if (storedSelectedModels) {
        selectedModels = JSON.parse(storedSelectedModels);
      }
    }

    function getResponses() {
      const inputText = document.getElementById('inputText').value;
      if (inputText.trim() === '') return;

      chatHistory.push({ text: inputText, sender: 'user' });
      document.getElementById('inputText').value = '';
      saveChatHistory(); // 用户发送消息后立即保存

      selectedModels.forEach((model, index) => {
        fetchResponse(model, inputText, index);
      });
    }

    function fetchResponse(model, inputText, index) {
      const requestBody = {
        model: model.name,
        prompt: inputText,
        api_key: model.api_key
      };

      fetch(model.api_url, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(requestBody)
      })
        .then(response => response.json())
        .then(data => {
          chatHistory.push({ text: data.response, sender: model.name });
          saveChatHistory(); // 模型返回消息后立即保存
          updateChatDisplay();
        })
        .catch(error => {
          chatHistory.push({ text: `Error: ${error.message}`, sender: model.name });
          saveChatHistory(); // 保存错误信息到聊天记录
          updateChatDisplay();
        });
    }

    function updateChatDisplay() {
      const chatHistoryContainer = document.getElementById('chatHistoryContainer');
      chatHistoryContainer.innerHTML = '';
      chatHistory.forEach(entry => {
        const messageDiv = document.createElement('div');
        messageDiv.className = `chat-message ${entry.sender}`;
        messageDiv.innerText = `[${entry.sender}]: ${entry.text}`;
        chatHistoryContainer.appendChild(messageDiv);
      });
      chatHistoryContainer.scrollTop = chatHistoryContainer.scrollHeight;
    }

    function toggleHistoryModal() {
      showHistoryModal = !showHistoryModal;
      updateHistoryListDisplay();
    }

    function updateHistoryListDisplay() {
      const historyModal = document.getElementById('historyModal');
      historyModal.style.display = showHistoryModal ? 'block' : 'none';
      if (showHistoryModal) {
        const historyList = document.getElementById('historyList');
        historyList.innerHTML = '';
        chatHistoryList.forEach((history, index) => {
          const listItem = document.createElement('li');
          listItem.innerText = history.timestamp;
          listItem.onclick = () => loadHistory(index);
          historyList.appendChild(listItem);
        });
      }
    }
  </script>
</body>
</html>